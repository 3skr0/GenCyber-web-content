<!--
	Gencyber web content: Day 1. These files are intended to provide step-by-step self paced tutorials to teachers seeking to learn about cybersecurity first principles as part of the UNO Gencyber camp.
	Copyright (C) 2016  Dr. Matthew L. Hale

	This program is free software: you can redistribute it and/or modify
	it under the terms of the GNU General Public License as published by
	the Free Software Foundation, either version 3 of the License, or
	(at your option) any later version.

	This program is distributed in the hope that it will be useful,
	but WITHOUT ANY WARRANTY; without even the implied warranty of
	MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
	GNU General Public License for more details.

	You should have received a copy of the GNU General Public License
	along with this program.  If not, see <http://www.gnu.org/licenses/>.
-->
<html>
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1">
		<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css">
		<link rel="stylesheet" title="Monokai Sublime" href="css/monokai-sublime.css">
		<link rel="shortcut icon" href="favicon.ico" type="image/x-icon" />
		<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.2/jquery.min.js"></script>
		<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js"></script>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/8.6/highlight.min.js"></script>
		<script>hljs.initHighlightingOnLoad();</script>
		<title>Gencyber Day Two</title>
		<style>
			#unologo{font-size: 1.2em;text-transform:uppercase;font-family:'urwgroteskregular';color:#FFF;display:inline-block;vertical-align:middle;margin-top:10px;margin-left:3px;font-weight:bold;}
			.logo {
				float: left;
				margin-left: 0px;
				margin-top: 5px;
			}

			#tagline{font-size: 1em;font-family:'urwgroteskregular';color:#FFF;display:inline-block;vertical-align:middle;margin-top:15px;margin-left:30px;font-weight:bold;}

			.tagline {
				float: left;
				margin-left: -175px;
				margin-top: 25px;
			}
			#main{
				margin-top: 90px;
				margin-bottom: 50px;
				margin-left: 0px;
				width: 100%;
			}

			pre {padding: 0em;}
			img {
				padding-bottom: 20px;
				padding-top: 10px;
			}
			body {
				font-size: 16px;
				position: relative;
			}

			.copy-stmt {
				margin-right: 20px;
			}
			#leftnav ul {
				position: fixed;
			}
			#leftnav ul li a {
				padding-top: 2px;
				padding-bottom: 2px;

			}
			#taskitem {
				min-height: 1px;
				height: 1000px;
			}
			#scrollable-content {
				position: relative;
				height: 100%;
				overflow-y: scroll;
			}
			:target:before {
				content:"";
				display:block;
				height:90px; /* fixed header height*/
				margin:-90px 0 0; /* negative fixed header height */
			}


		</style>
	</head>
	<body>
		<!-- <nav class="navbar navbar-inverse navbar-fixed-top">
			<div class="container">
				<div class="navbar-header">
					<img alt="University of Nebraska Omaha" src="images/logo-subsite-o-2.png">
					<p id="unologo">UNO: Techademy</p>
					<p id="tagline">Secure Web Development &copy; 2016 - Dr. Matt Hale</p>
				</div>
			</div>
		</nav> -->
		<nav class="navbar navbar-inverse navbar-fixed-top">
			<div class="container">
				<div class="row">
					<img alt="University of Nebraska Omaha" src="images/logo-subsite-o-2.png" style="float: left;">
					<div class="row logo">
						<p id="unologo">UNO: Gencyber</p>
					</div>
					<div class="row tagline">
						<p id="tagline">Day Two &copy; 2016 - Dr. Matthew Hale</p>
					</div>
				</div>
			</div>
		</nav>
		<div id="main" class="container">
			<div class="row">
				<nav class="col-sm-1 hidden-xs" id="leftnav">
					<ul class="nav nav-pills nav-stacked">
						<h5>Step:</h5>
						<li><a href="#task1">1</a></li>
						<li><a href="#task2">2</a></li>
						<li><a href="#task3">3</a></li>
						<li><a href="#task4">4</a></li>
						<li><a href="#task5">5</a></li>
						<li><a href="#task6">6</a></li>
						<li><a href="#task7">7</a></li>
						<li><a href="#task8">8</a></li>
						<li><a href="#task9">9</a></li>
						<li><a href="#task10">10</a></li>
						<li><a href="#task11">11</a></li>
						<li><a href="#task12">12</a></li>
						<li><a href="#task13">13</a></li>
						<li><a href="#task14">14</a></li>
						<li><a href="#task15">15</a></li>
						<li><a href="#task16">16</a></li>
						<li><a href="#task17">17</a></li>
						<li><a href="#task18">18</a></li>
						<li><a href="#task19">19</a></li>
						<li><a href="#task20">20</a></li>
						<li><a href="#task21">21</a></li>
						<li><a href="#task22">22</a></li>
					</ul>
				</nav>
				<!--start content -->
				<div class="col-sm-11 col-xs-12" id="scrollable-content" data-spy="scroll" data-target="#leftnav" data-offset="90">
					<div class="jumbotron">
						<h1>Welcome to Gencyber Day 2</h1>
						<p>This guide will get you up and running with Apache, Django, and Django REST framework. You may want to replace 'myapp' with your actually application name below.</p>
						<p><a class="btn btn-primary btn-lg" href="#task1" role="button">Get started</a></p>
					</div>
					<div class="list-group">
						<a href="#task1" class="list-group-item">UNIT 1: Installing Apache and Django and configuring a dev. and production enviornment</a>
						<a href="#task4" class="list-group-item">UNIT 2: Integrating the server-side and client-side</a>
						<a href="#task5" class="list-group-item">UNIT 3: Adding Authentication and sessions</a>
						<a href="#task5" class="list-group-item">UNIT 4: Adding a user profile</a>
						<a href="#task5" class="list-group-item">UNIT 5: Access control and Permissions</a>
						<a href="#task5" class="list-group-item">UNIT 6: Input filtering and API hardening</a>
					</div>
					<div id="task1" class="taskitem">
						<h2>UNIT1: Unit 1: Installing Apache and Django and configuring a dev. and production enviornment</h2>
						<h3 class="taskitem">1. Installing and running Apache</h3>

			            Open your ubuntu server-vm. Once its booted up, login and then press ctrl+alt+t to open a new terminal <br>
			           	To install apache type the following in the terminal:<br>
			            <pre><code>sudo apt-get update
sudo apt-get install apache2</code></pre><br>
			            <br>
			            You should see: <img src="images/apache-install.png"/><br>

			            Lets run apache and confirm that "It Works!"<br>
			            To do so, restart apache from the command line via:<br>
			            <pre><code>sudo service apache2 restart</code></pre><br>
			            <br>
			            With the server restarted, open your a browser (click chrome icon on the left) and navigate to "localhost" (without quotes)
			            You should see the default configuration running and it should look something like this:<br>
			            <img src="images/apache-it-works.png"/><br>
			            <br>
			            At this point you are hosting a webserver just like you would find almost anywhere online. Pretty simple to start with right? Well at this point apache is just serving a single page called a "static file." You can find this page (the configuration page) in the /var/www/html/ directory using the file browser or command line. Open it up and take a look and you will see the raw html used to make the "It works" page.

					</div><!-- End Task 1-->
					<div id="task2" class="taskitem">
						<h3 class="taskitem">2. Setup your development environment: Installing Django and Forking the starter serverside code</h3>
			            
			            Now that we have a default install of apache ready, lets make our webserver more interesting by installing and configuring a web application framework called "Django" to work with the server. We will start with setting up a development environment. Step 3 will get django setup for production<br>

			            First install Django by typing the following in the command line:<br>
			            <pre><code>sudo apt-get install python-pip
pip install Django==1.9.7</code></pre><br>
			           	Easy enough to install...<br>
			            Next, lets create your first Django app by starting with some basic code I created for you to get going.<br>
						
						Go to <a href="https://github.com/MLHale/gencyberdjango">https://github.com/MLHale/gencyberdjango</a> and fork the repository by clicking the "fork" button in the upper right.<br>
						<img src="images/fork-django-project.png"/><br>

						This should create a copy of the repository that you can control.<br> 
						<img src="images/forked-repo.png"/><br>
						When you are done it should look something like:<br>
						<img src="images/forked-repo2.png"/><br>
						Notice in the red elipse that you now have your own copy of the repo. If you go to "https://github.com/&lt;yourusername&gt;/gencyberdjango" you should see it.<br>
			            Back in your virtual machine, lets get started with this code (we will review what is in there in a moment)<br>
			            (make sure to replace &lt;yourusername&gt; with your actual github username)
			            <pre><code>sudo chown student:www-data -R /var/www/
cd /var/www/
git clone https://github.com/&lt;yourusername&gt;/gencyberdjango gencybersite
cd gencybersite/</code></pre><br>
		            	
			            With this project, you will get a directory structure that looks like
			            <img src="images/django-project-structure.png"/><br>

			            Now that we have Django installed and a project running we should be able to test Django in development mode using a utility called "runserver" that runs a development version of django for you to develop your code with. This utility provides real-time recompilation as you edit python files and keeps your app hosted on localhost:8000. This is helpful for testing purposes. The utility also provides real-time feedback every time you save python files in your django directory. This can help you debug if you make errors along the way. Lets take a look at runserver now:<br>
			            <pre><code>python manage.py runserver</code></pre><br>
			            You should see something that looks like:
			            <img src="images/django-runserver.png"/><br>
			            Now, open up a chrome browser window and navigate to localhost:8000/api/<br>
			            You should see that your django server is running and that there are three types of data served by your api: users, likes, and userprofiles. 
						<img src="images/api-running-in-runserver.png"/><br>
						Lets investigate these data structures using the django admin interface. In your browser go to localhost:8000/admin/ and login using the username/password student/studentgencyber Then, click on like and then on "someflickrphototitle". Also take a look at the userprofile and user models.<br>
						You should see something like: <img src="images/admin-interface.png"/><br>
						then: <img src="images/admin-interface2.png"/><br>
						Then: <img src="images/admin-interface3.png"/><br>

						Feel free to manipulate some fields and click "save"<br>

						Now lets take a look at these items as our application will eventually see them: that is of course, in JSON format (javascript object notation).<br>
						Go to localhost:8000/api/likes and you should see: <br>
						then: <img src="images/api-likes.png"/><br>
			        </div><!-- End Task 2-->
			        <div id="task3" class="taskitem">
			        	<h3 class="taskitem">3. Configuring Django for production</h3>
			        	In the first step we installed apache. In the second, we install django. Notice they are running on different ports (port 80 for apache, i.e. just localhost, and port 8000 for django, i.e. localhost:8000). What we want is to setup apache to actually host django - so that when we make changes to our development enviornment we can 'push' them to production. Usually your production server would be an entirely different system. For the rest of this tutorial, we will just use a seperate folder. Lets get this setup. <br>

			        	First, start by cloning your django repo into a new folder.
			        	<pre><code>cd /var/www/
git clone https://github.com/&lt;yourusername&gt;/gencyberdjango production
sudo find /var/www/production/ -type d -exec chmod 775 {} +
sudo find /var/www/production/ -type f -exec chmod 664 {} +
sudo chown -R student:www-data /var/www/production/
cd production</code></pre><br>
						Now you have two copies of django, one for development in /var/www/gencybersite/ and one in /var/www/production/ that you will be letting apache serve. <br>
						Lets get this 'production environment' (a term based in the domain seperation and layering first principles) configured. <br>

						You will need a module called mod_wsgi to allow apache to talk to the django python kernel (a run time environment for python). Lets go ahead and install it:<br>

			            <pre><code>sudo apt-get install libapache2-mod-wsgi</code></pre>
			            This library allows Django to tell apache what to serve at any given time. <br>
			            To make it work, we need to make some changes to our apache configuration file in /etc/apache2/sites-available/ to tell it to host django instead of the default "it works" page that we started with.
			            <br>
			            Lets take a look at our current running apache config: open a new terminal window (ctrl+shift+t in terminal) and type<br>
			            <pre><code>nano /etc/apache2/sites-available/000-default.conf</code></pre><br>
			            Notice that it is hosting the files in /var/www/html/ that we looked at in step 1.<br>
						<img src="images/apache-default-conf.png"/><br>
			            To change it to django lets disable this site and create a new virtualhost setup for django:<br>
			            First, lets create the new virtualhost conf file.
			            <pre><code>sudo nano /etc/apache2/sites-available/django.conf</code></pre>
			            Copy the following and paste it into the conf file (right click the terminal, select paste):<br>
			            <pre><code>&lt;VirtualHost *:80&gt;
        ServerName localhost

        ServerAdmin youremail@youremail.edu

        # Available loglevels: trace8, ..., trace1, debug, info, notice, warn,
        # error, crit, alert, emerg.
        # It is also possible to configure the loglevel for particular
        # modules, e.g.
        LogLevel info

        ErrorLog ${APACHE_LOG_DIR}/error.log
        CustomLog ${APACHE_LOG_DIR}/access.log combined

        Alias /static/ /var/www/production/static
        
        #allow access to static files
        &lt;Directory /var/www/production/static&gt;
            Options -Indexes
            Require all granted
        &lt;/Directory&gt;

        #allow access to wsgi file
        &lt;Directory /var/www/production/gencybersite&gt;
            &lt;Files wsgi.py&gt;
                Require all granted
            &lt;/Files&gt;
        &lt;/Directory&gt;

        ServerSignature Off
&lt;/VirtualHost&gt;
WSGIScriptAlias / /var/www/production/gencybersite/wsgi.py
WSGIPythonPath /var/www/production/:/home/student/.local/lib/python2.7/site-packages/</code></pre><br>
						To make these files active lets give apache access to site-packages and then reload and restart our server. The first command gives permission 7 to the owner (the first 7), 7 to group (the second 7), and 5 to all others (the 5).<br>
						The numbers can range from: 0 to 7 as follows:
						<ul>
							<li>0 – no permission</li>
							<li>1 – execute</li>
							<li>2 – write</li>
							<li>3 – write and execute</li>
							<li>4 – read</li>
							<li>5 – read and execute</li>
							<li>6 – read and write</li>
							<li>7 – read, write, and execute</li>
						</ul>
						<br>
						The second command (find) grabs every directory (given by -type d) beneath the path ( /home/student/.local/lib ) and changes its permissions to 755.<br>
						<pre><code>sudo chmod 775 /home/student/.local
find /home/student/.local/lib -type d -exec chmod 755 {} +
cd /var/www/
sudo service apache2 reload
sudo service apache2 restart</code></pre><br>
						This virtual host is apache's way of binding certain ports to certain hosted files. In this configuration we are enabling django to run inside of apache using the WSGI interface. The WSGIScriptAlias maps to the wsgi.py file in our django install and the python path points to the directory where our project code is at. This configuration also hosts a static files directory that can be used to host any static files (like css or js or ...your ember flickr app).<br>
						<br>

						If all goes well, you should see the same app as before, but hosted on localhost: e.g.<br>
						<img src="images/apache-django-configured.png"/><br>
						Now we have two specific setups. One for development (/var/www/gencybersite) and one for production (/var/www/production/). Henceforth, we will make coding changes in development, push our changes to our github repo and then pull them down into our production setup when we are ready.<br>
			        </div><!-- End Task 3-->

			        <div id="task4" class="taskitem">
			        	<h2>UNIT 2: Integrating the server-side and client-side</h2>
			        	<h3 class="taskitem">4. Configuring Ember with Django</h3>
			        	Now comes the part where you bring together everything you've done so far: integrating your api and your client-side app. <br>

			            Lets start by integrating this api with the flickr app we built on day 1.<br>
			            If you didn't entirely finish, or made a mistake, its ok - you can fork the repo at <a href="https://github.com/MLHale/gencyberember">https://github.com/MLHale/gencyberember</a><br>
			            This repo contains code that has been checkpointed to be in the state that you would have been if you finished all of the steps in day 1. <br>
			            Just so we are all on the same page, lets go ahead and fork this repo on github and then do the following: (make sure to replace 'yourusername' with your actual username.<br>

			            <pre><code>cd /var/www/
git clone https://github.com/yourusername/gencyberember.git /var/www/ember
cd ember
git reset 02a023b3 --hard
npm install
bower install</code></pre><br>
			            The reset hard command will revert the code back to the starting point for this tutorial. If you want to look at where you are going, a finished copy is available at the last commit.<br>
			            After you have the app installed, lets add it to the sublime project workspace:<br>

			            <img src="images/add-folder.png"/><br>
			            <img src="images/select-folder.png"/><br>

			            When you have it added, your workspace should look like:<br>
			            <img src="images/project-workspace.png"/><br>

			            Now comes the integration step. In your terminal type the following:<br>
			            <pre><code>cd /var/www/ember
ember build --watch -o /var/www/gencybersite/static/ember</code></pre><br>
			            Now you should see a familiar ember build watch running. The only difference is now it is building into a direcotry other than /dist/. Specifically it is building into a static folder called "ember/" in /var/www/gencybersite/static/<br> 
			            <br>
			            <img src="images/ember-build.png"/><br>

			            Now we just need to tell django to host ember on our root url<br>
			            In another terminal window (ctrl+shift+t for a new one) run runserver as follows:<br>
			            <pre><code>cd /var/www/gencybersite/
python manage.py runserver</code></pre><br>
						To review, you now have runserver going for your django development environment, you have ember-cli building ember files into your django app, and you have apache running to host your production server.<br>

			            In sublime, open /var/www/gencybersite/gencybersite/settings.py<br>
			            Find "TEMPLATES" then change the "DIRS" line to:<br>
			            <pre><code>'DIRS': ['static/ember/'],</code></pre><br>

			            <img src="images/templates-dir.png"/><br>

			            Now lets go to views.py in /api and add:<br>
			            <pre><code>def home(request):
  """
  Send requests to / to the ember.js clientside app  """
  
  return render_to_response('index.html',
                {}, RequestContext(request))</code></pre><br>
                		<img src="images/home-template.png"/><br>



			            Then in urls.py (in /var/www/gencybersite/gencybersite) after the other import statements add:<br>
			            <pre><code>from api import views</code></pre><br>
			            Then after the api/ pattern, add:<br>
			            <pre><code> url(r'^', views.home),</code></pre><br>
			            <br>

			            At this point your urls.py file should look like:<br>
			            <img src="images/urls-py.png"/><br>

			            This url configuration cascades through admin/ then api/. If it matches one of those, it will be sent to the corresponding set of views. Otherwise, every other possible url will be mapped to the views.home view - which is conveiently hosting our ember app. What this means is that django will offload all urls that don't match the first two patterns to ember (where, they will be handled by the ember client-side router). Nifty yeah?<br>

			            To make it all work we need to do one more thing<br>
			            The asset files aren't hosted at /assets/ as they are in the ember-cli build placement.<br>
			            To fix this, open your /var/www/ember/app/index.html file and ctrl-h (replace) the word 'assets' with 'static/ember/assets'<br>

			            It should look like:<br>
			            <img src="images/asset-static-fix.png"/><br>
			            AND THE BUILD PROCESSES ALIGN - AT LAST<br>

			            Now we can edit our ember files, ember-cli will watch for changes and build the result into our django static-file directory.<br>
			            On the server-side code, if we make changes to our django files, django manage.py will watch for and observe the changes and then restart the server automatically.<br>
			            <br>
			            If everything is setup correctly you should see:<br>
			            <img src="images/django-ember.png"/><br>
			            This is really nifty and accelerates development<br>
			            When the app is working as you like it, you can just release it to production via a git push on the development environment and a git pull on the production server. Through this build process, the compiled ember files will be just another script in the /static folder of the django repository and you can still manage client-side code changes from your ember repository (since they are in seperate git repos)<br>

			            To save our changes and push to production (illustrating our build process), lets do the following:<br>
			            <pre><code>cd /var/www/gencybersite/
git status
git add .
git commit -m "ember and django integrated"
git push</code></pre><br>

			        </div><!-- End Task 4-->
			        <div id="task5" class="taskitem">
			        	<h2>UNIT 3: Adding Authentication and sessions</h2>
			        </div><!-- End Task 5-->
			        <div id="task6" class="taskitem">
			        </div><!-- End Task 6-->
			        <div id="task7" class="taskitem">
			        </div><!-- End Task 7-->
			        <div id="task8" class="taskitem">
			        </div><!-- End Task 8-->
			        <div id="task9" class="taskitem">
			        </div><!-- End Task 9-->

				</div><!--end scrollable content -->
				<!-- Copyright info -->
				<a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/4.0/"><img alt="Creative Commons License" style="border-width:0" src="https://i.creativecommons.org/l/by-nc-sa/4.0/88x31.png" /></a><br /><span xmlns:dct="http://purl.org/dc/terms/" property="dct:title">UNO Gencyber Content</span> by <a xmlns:cc="http://creativecommons.org/ns#" href="mlhale.com" property="cc:attributionName" rel="cc:attributionURL">Dr. Matthew L. Hale</a> is licensed under a <a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/4.0/">Creative Commons Attribution-NonCommercial-ShareAlike 4.0 International License</a>.<br />Based on a work at <a xmlns:dct="http://purl.org/dc/terms/" href="https://github.com/MLHale/GenCyber-web-content" rel="dct:source">https://github.com/MLHale/GenCyber-web-content</a>.
			</div><!-- end row -->
			
			
			

		</div><!-- end main -->
		<p class="text-muted pull-right copy-stmt">Secure Web Development &copy; 2015 - Dr. Matt Hale</p>
	</body>
</html>